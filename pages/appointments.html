<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Appointments</title>
  <link rel="stylesheet" href="../styles/sidebar.css">
  <link rel="stylesheet" href="../styles/global.css">
  <link rel="stylesheet" href="../styles/users.css">
</head>

<body>
  <div class="container">
    <side-bar></side-bar>

    <div class="main">
      <section id="appointments">
        <h1>Appointments</h1>

        <!-- Controls -->
        <div class="controls">
          <input type="text" id="searchInput" placeholder="Search by pet, owner, or ID...">

          <select id="statusFilter">
            <option value="">All Status</option>
            <option value="Scheduled">Scheduled</option>
            <option value="Completed">Completed</option>
            <option value="Canceled">Canceled</option>
            <option value="No-show">No-show</option>
          </select>

          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="Check Up">Check Up</option>
            <option value="Vaccination">Vaccination</option>
            <option value="Grooming">Grooming</option>
            <option value="Follow-up">Follow-up</option>
            <option value="Emergency">Emergency</option>
          </select>
        </div>

        <!-- Appointments Table -->
        <table id="appointmentsTable">
          <thead>
            <tr>
              <th>Appointment ID</th>
              <th>Pet Name</th>
              <th>Owner Name</th>
              <th>Date</th>
              <th>Time</th>
              <th>Type</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" style="display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:10px; width:400px;">
      <h2>Edit Appointment</h2>

      <form id="editForm">
        <label>Pet Name</label>
        <input id="editPetName" type="text" disabled>

        <label>Owner Name</label>
        <input id="editOwnerName" type="text" disabled>

        <label>Date</label>
        <input id="editDate" type="date" required>

        <label>Time</label>
        <input id="editTime" type="time" required>

        <label>Type</label>
        <select id="editType" required>
          <option value="Check Up">Check Up</option>
          <option value="Vaccination">Vaccination</option>
          <option value="Grooming">Grooming</option>
          <option value="Follow-up">Follow-up</option>
          <option value="Emergency">Emergency</option>
        </select>

        <label>Status</label>
        <select id="editStatus" required>
          <option value="Scheduled">Scheduled</option>
          <option value="Completed">Completed</option>
          <option value="Canceled">Canceled</option>
          <option value="No-show">No-show</option>
        </select>

        <div style="margin-top:20px; text-align:right;">
          <button type="button" id="cancelEdit">Cancel</button>
          <button type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ----------------------------------------------------------
   FIREBASE SETUP
----------------------------------------------------------*/
const firebaseConfig = {
  apiKey: "BOQout55yLWUT_u5i4RUnKn7YWjdEVomWAjCkXz3IvTaVVkeCdDEa1TNOlfwKp_9ywtk9N8_xWSesl1MeJQMJbI",
  authDomain: "fitfurs12.firebaseapp.com",
  projectId: "fitfurs12",
  storageBucket: "fitfurs12.appspot.com",
  messagingSenderId: "875211703765",
  appId: "1:875211703765:android:b069bfa50ec424172c295c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tableBody = document.querySelector("#appointmentsTable tbody");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const typeFilter = document.getElementById("typeFilter");

// Stores references to each appointment
let appointmentIndex = [];

/* ----------------------------------------------------------
   LOAD APPOINTMENTS (Nested)
----------------------------------------------------------*/
async function loadAppointments() {
  tableBody.innerHTML = "";
  appointmentIndex = [];

  const usersSnap = await db.collection("users").get();

  for (let userDoc of usersSnap.docs) {
    const userId = userDoc.id;
    const userData = userDoc.data();
    const ownerName = userData.username || "Unknown";

    const petsSnap = await db.collection("users")
      .doc(userId).collection("pets").get();

    for (let petDoc of petsSnap.docs) {
      const petId = petDoc.id;
      const petData = petDoc.data();

      const appointmentsSnap = await db.collection("users")
        .doc(userId).collection("pets")
        .doc(petId).collection("appointments")
        .get();

      appointmentsSnap.forEach(apptDoc => {
        const appt = apptDoc.data();
        const apptId = apptDoc.id;

        appointmentIndex.push({
          apptId,
          userId,
          petId,
          data: appt,
          petName: petData.petName,
          ownerName: ownerName
        });

        const row = document.createElement("tr");
        row.dataset.index = appointmentIndex.length - 1;

        row.innerHTML = `
          <td>${apptId}</td>
          <td>${petData.petName || ""}</td>
          <td>${ownerName}</td>
          <td>${appt.date}</td>
          <td>${appt.time}</td>
          <td>${appt.reason}</td>
          <td>${appt.status}</td>
          <td>
            <button class="edit-btn">Edit</button>
            <button class="delete-btn">Delete</button>
          </td>
        `;

        tableBody.appendChild(row);
      });
    }
  }
}

loadAppointments();

/* ----------------------------------------------------------
   SEARCH + FILTER
----------------------------------------------------------*/
function filterAppointments() {
  const search = searchInput.value.toLowerCase();
  const filterStatus = statusFilter.value;
  const filterType = typeFilter.value;

  [...tableBody.rows].forEach(row => {
    const petName = row.cells[1].textContent.toLowerCase();
    const ownerName = row.cells[2].textContent.toLowerCase();
    const appointmentId = row.cells[0].textContent.toLowerCase();
    const status = row.cells[6].textContent;
    const type = row.cells[5].textContent;

    const matchSearch =
      petName.includes(search) ||
      ownerName.includes(search) ||
      appointmentId.includes(search);

    const matchStatus = !filterStatus || status === filterStatus;
    const matchType = !filterType || type === filterType;

    row.style.display = (matchSearch && matchStatus && matchType) ? "" : "none";
  });
}

searchInput.addEventListener("input", filterAppointments);
statusFilter.addEventListener("change", filterAppointments);
typeFilter.addEventListener("change", filterAppointments);

/* ----------------------------------------------------------
   EDIT / DELETE
----------------------------------------------------------*/
const editModal = document.getElementById("editModal");
const editForm = document.getElementById("editForm");

tableBody.addEventListener("click", async (e) => {
  const row = e.target.closest("tr");
  if (!row) return;

  const index = row.dataset.index;
  const apptInfo = appointmentIndex[index];
  const { userId, petId, apptId } = apptInfo;

  // EDIT
  if (e.target.classList.contains("edit-btn")) {
    document.getElementById("editPetName").value = row.cells[1].textContent;
    document.getElementById("editOwnerName").value = row.cells[2].textContent;
    document.getElementById("editDate").value = row.cells[3].textContent;
    document.getElementById("editTime").value = row.cells[4].textContent;
    document.getElementById("editType").value = row.cells[5].textContent;
    document.getElementById("editStatus").value = row.cells[6].textContent;

    editModal.style.display = "flex";

    editForm.onsubmit = async (ev) => {
      ev.preventDefault();

      await db.collection("users")
        .doc(userId).collection("pets")
        .doc(petId).collection("appointments")
        .doc(apptId)
        .update({
          date: document.getElementById("editDate").value,
          time: document.getElementById("editTime").value,
          reason: document.getElementById("editType").value,
          status: document.getElementById("editStatus").value
        });

      editModal.style.display = "none";
      loadAppointments();
    };
  }

  // DELETE
  if (e.target.classList.contains("delete-btn")) {
    if (confirm("Delete this appointment?")) {
      await db.collection("users")
        .doc(userId).collection("pets")
        .doc(petId).collection("appointments")
        .doc(apptId)
        .delete();

      loadAppointments();
    }
  }
});

// Cancel edit
document.getElementById("cancelEdit").addEventListener("click", () => {
  editModal.style.display = "none";
});
</script>
<script type="module" src="../main.js" defer></script>
</body>
</html>
