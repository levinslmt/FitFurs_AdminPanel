<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - Pets</title>
  <link rel="stylesheet" href="../styles/sidebar.css" />
  <link rel="stylesheet" href="../styles/global.css" />
  <link rel="stylesheet" href="../styles/users.css" />
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <side-bar></side-bar>

    <!-- MAIN -->
    <div class="main">
      <section id="pets">
        <h1>Pet Management</h1>

        <!-- Controls -->
        <div class="controls">
          <input type="text" id="searchInput" placeholder="Search by name, breed, or owner..." />
          <select id="speciesFilter">
            <option value="">All Species</option>
            <option value="Dog">Dog</option>
            <option value="Cat">Cat</option>
            <option value="Bird">Bird</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Table -->
        <table id="petTable">
          <thead>
            <tr>
              <th>Pet ID</th>
              <th>Pet Name</th>
              <th>Species</th>
              <th>Breed</th>
              <th>Age</th>
              <th>Owner</th>
              <th>Health Status</th>
              <th>Comment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- Edit Modal -->
  <div
    id="editModal"
    style="
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    "
  >
    <div
      style="
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
      "
    >
      <h2>Edit Pet</h2>

      <form id="editForm">
        <label>Pet Name</label>
        <input id="editPetName" type="text" required />

        <label>Species</label>
        <select id="editSpecies" required>
          <option value="Dog">Dog</option>
          <option value="Cat">Cat</option>
          <option value="Other">Other</option>
        </select>

        <label>Breed</label>
        <input id="editBreed" type="text" required />

        <label>Age</label>
        <input id="editAge" type="number" min="0" required />

        <label>Health Status</label>
        <select id="editHealth" required>
          <option value="Healthy">Healthy</option>
          <option value="Needs Check-up">Needs Check-up</option>
          <option value="Sick">Sick</option>
          <option value="Injured">Injured</option>
        </select>

        <label>Comment</label>
        <textarea id="editComment" rows="3"></textarea>

        <div style="margin-top: 20px; text-align: right;">
          <button type="button" id="cancelEdit">Cancel</button>
          <button type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Unified Firebase config (same as login page)
    const firebaseConfig = {
      apiKey: "AIzaSyDhFZkXI6ZEyBCr700KBklOnfXUEg9T-2M",
      authDomain: "fitfurs12.firebaseapp.com",
      databaseURL: "https://fitfurs12-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fitfurs12",
      storageBucket: "fitfurs12.firebasestorage.app",
      messagingSenderId: "875211703765",
      appId: "1:875211703765:web:2920f00bad00085b2c295c",
      measurementId: "G-M2Z32GHDHS"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Auth state listener: Redirect to login if not authenticated
    auth.onAuthStateChanged(user => {
      if (!user) {
        console.log("No user authenticated, redirecting to login...");
        window.location.href = "./index.html";  // Adjust path if needed (e.g., "../index.html" if dashboard is in pages/)
      } else {
        console.log("User authenticated:", user.email);
      }
    });

    const tableBody = document.querySelector('#petTable tbody');
    const searchInput = document.getElementById('searchInput');
    const speciesFilter = document.getElementById('speciesFilter');

    /* -----------------------------------------------
        LOAD PETS FROM USERS > userId > pets
    ------------------------------------------------ */
    async function loadPets() {
      try {
        tableBody.innerHTML = '';
        const usersSnapshot = await db.collection('users').get();
        console.log('Users count:', usersSnapshot.size);

        for (const userDoc of usersSnapshot.docs) {
          const userData = userDoc.data();
          const userId = userDoc.id;

          const petsSnapshot = await db.collection('users').doc(userId).collection('pets').get();
          console.log(`Pets count for user ${userId}:`, petsSnapshot.size);

          petsSnapshot.forEach((petDoc) => {
            const pet = petDoc.data();

            const row = document.createElement('tr');
            row.dataset.userId = userId;
            row.dataset.petId = petDoc.id;

            row.innerHTML = `
              <td>${petDoc.id}</td>
              <td>${pet.petName || ''}</td>
              <td>${pet.species || ''}</td>
              <td>${pet.breed || ''}</td>
              <td>${pet.age || ''}</td>
              <td>${userData.username || userData.email || ''}</td>
              <td>${pet.healthStatus || ''}</td>
              <td>${pet.comment || ''}</td>
              <td>
                <button class="edit-btn">Edit</button>
                <button class="delete-btn">Delete</button>
              </td>
            `;

            tableBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error('Error loading pets:', error);
      }
    }

    // Load pets once DOM content is loaded
    document.addEventListener('DOMContentLoaded', loadPets);

    /* -----------------------------------------------
        SEARCH & FILTER
    ------------------------------------------------ */
    function filterPets() {
      const search = searchInput.value.toLowerCase();
      const filterSpecies = speciesFilter.value;

      for (let row of tableBody.rows) {
        const name = row.cells[1].textContent.toLowerCase();
        const breed = row.cells[3].textContent.toLowerCase();
        const owner = row.cells[5].textContent.toLowerCase();
        const species = row.cells[2].textContent;

        const matchesSearch =
          name.includes(search) ||
          breed.includes(search) ||
          owner.includes(search);

        const matchesSpecies = !filterSpecies || species === filterSpecies;

        row.style.display = matchesSearch && matchesSpecies ? '' : 'none';
      }
    }

    searchInput.addEventListener('input', filterPets);
    speciesFilter.addEventListener('change', filterPets);

    /* -----------------------------------------------
        EDIT / DELETE ACTIONS (WITH UPDATED ACTIVITY LOGGING)
    ------------------------------------------------ */
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');

    tableBody.addEventListener('click', async (e) => {
      const row = e.target.closest('tr');
      if (!row) return;

      const userId = row.dataset.userId;
      const petId = row.dataset.petId;
      const petName = row.cells[1].textContent;

      // EDIT
      if (e.target.classList.contains('edit-btn')) {
        document.getElementById('editPetName').value = row.cells[1].textContent;
        document.getElementById('editSpecies').value = row.cells[2].textContent;
        document.getElementById('editBreed').value = row.cells[3].textContent;
        document.getElementById('editAge').value = row.cells[4].textContent;
        document.getElementById('editHealth').value = row.cells[6].textContent.trim();
        document.getElementById('editComment').value = row.cells[7].textContent;

        editModal.style.display = 'flex';

        editForm.onsubmit = async (ev) => {
          ev.preventDefault();

          const updatedPetName = document.getElementById('editPetName').value;
          const adminUser = auth.currentUser;

          try {
            await db.collection('users').doc(userId).collection('pets').doc(petId).update({
              petName: updatedPetName,
              species: document.getElementById('editSpecies').value,
              breed: document.getElementById('editBreed').value,
              age: Number(document.getElementById('editAge').value),
              healthStatus: document.getElementById('editHealth').value,
              comment: document.getElementById('editComment').value,
            });

            if (adminUser) {
              await db.collection('activities').add({
                type: 'pet_edited',
                description: `Admin updated pet details - Pet: ${updatedPetName}`,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                userId: adminUser.uid,
                petId: petId,
              });
              console.log('Activity logged for update.');
            } else {
              console.error('No authenticated admin user. Cannot log activity.');
            }

            editModal.style.display = 'none';
            loadPets();
          } catch (error) {
            console.error('Error updating pet or logging activity:', error);
            alert('Failed to update pet. Check console for details.');
          }
        };
      }

      // DELETE
      if (e.target.classList.contains('delete-btn')) {
        if (!confirm('Delete this pet?')) return;

        const adminUser = auth.currentUser;

        try {
          if (adminUser) {
            await db.collection('activities').add({
              type: 'pet_deleted',
              description: `Admin deleted pet - Pet: ${petName}`,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              userId: adminUser.uid,
              petId: petId,
            });
            console.log('Activity logged for delete.');
          } else {
            console.error('No authenticated admin user. Cannot log activity.');
          }

          await db.collection('users').doc(userId).collection('pets').doc(petId).delete();

          loadPets();
        } catch (error) {
          console.error('Error deleting pet or logging activity:', error);
          alert('Failed to delete pet. Check console for details.');
        }
      }
    });

    document.getElementById('cancelEdit').addEventListener('click', () => {
      editModal.style.display = 'none';
    });
  </script>

  <script type="module" src="../main.js" defer></script>
</body>
</html>